---
title: "Pernoctaciones en alojamientos turísticos de turistas extranjeros"
subtitle: "Descriptiva"
author: "Iván Arribas (Depto. Análisis Económico. Universitat de València)"
output: 
  html_document:
    theme: cerulean
    highlight: pygments 
    fig_caption: false
    df_print: kable
    toc: true
    toc_depth: 2
    toc_float: 
      collapsed: true
    number_sections: true
    self_contained: true
    code_download: true
---

```{r chunk_setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE, 
                      comment = "",
                      fig.align = "center", 
                      fig.show = "hold",
                      fig.height = 4,
                      fig.width = 8,
                      out.width = "80%") 
```

```{r options_setup, echo = FALSE}
options(scipen = 999) #- para quitar la notacion cientifica
```

```{r librerias, echo = FALSE}
library(forecast)
library(ggplot2); theme_set(theme_bw())
library(gridExtra)
library(grid)
```

\
\

# Introducción

Vamos a considerar la serie temporal correspondiente al número de pernoctaciones que los turistas extranjeros realizan en España en alojamientos turísticos autorizados (que llamaremos Pernoctaciones en adelante). Esta serie está disponible en Eurostat desde enero de 2000 hasta diciembre de 2019, un total de 20 años y 240 observaciones.

La serie y su fechado están en el fichero "Pernoctaciones.csv".


```{r}
Pernoctaciones <- read.csv2("./series/Pernoctaciones.csv", header = TRUE)
Pernoctaciones <- ts(Pernoctaciones[,2], start = 2000, freq = 12)
```

\
\

# Análisis preliminar gráfico

La gráfica de la serie temporal (figura 1) muestra una __tendencia__ decreciente en el número de pernoctaciones en la primera década del presente siglo, más marcada al inicio de la pasada crisis económica. Con el cambio de década se produce un cambio en la tendencia, aunque en los dos últimos años se ha producido una caída en el número de pernoctaciones. 

Las líneas verticales de la figura 1 marcan los meses de enero de cada año y permiten identificar mejor la posible __componente estacional__. Las pernoctaciones aumentan drásticamente en verano, especialmente en Julio y Agosto, asociadas a las vacaciones estivales. En menor medida se observa el efecto de la Semana Santa. Más adelante haremos un análisis detallado de la estacionalidad.

```{r}
autoplot(Pernoctaciones/1000000,
         xlab = "",
         ylab = "Noches (millones)",
         main = "Figura 1. Pernoctaciones") +
  scale_x_continuous(breaks= seq(2000, 2020, 2)) 
```

Parece que conforme disminuye el número pernoctaciones, también disminuye la amplitud estacional. Al inicio del siglo la diferencia entre los meses con más y con menos pernoctaciones superaba los 8 millones de pernoctaciones, mientras que a finales de la primera década esta diferencia no llegaba a los 7 millones de pernoctaciones. Parece, por tanto, que estamos ante un __esquema multiplicativo__. Para confirmar este aspecto, se ha realizado un gráfico de puntos entre el numero anual de pernoctaciones y la desviación típica intra-anual (figura 2).

```{r}
CasosAnual = as.numeric(aggregate(Pernoctaciones, FUN = sum))
DesviacionAnual = as.numeric(aggregate(Pernoctaciones, FUN = sd))

ggplot() +
  geom_point(aes(x = CasosAnual, y = DesviacionAnual), size = 2) +
  xlab("Pernoctaciones anuales") + 
  ylab("Desviación típica intra-anual") + 
  ggtitle("Figura 2: Análisis del tipo de esquema") 
```

Efectivamente, los años con mayor número de pernoctaciones se corresponden con una mayor variabilidad intra-anual, por lo que confirmamos el esquema multiplicativo de la serie.

\
\

# Análisis de las componentes

\

## Tendencia

Hemos obtenido la serie anual pernoctaciones, que presentamos en la figura 3. Se confirma la tendencia decreciente de la primera década. En el año 2000 el número de pernoctaciones alcanzaba las 90 millones al año, mientras que en 2009 toco fondo con menos de 60 millones. En los años siguientes se produce una recuperación de las pernoctaciones (a pesar de la crisis económica), sin llegarse a recuperar los niveles de principios de siglo. En los dos últimos años disponibles las pernoctaciones han vuelto a caer.

```{r}
autoplot(aggregate(Pernoctaciones/1000000, FUN = sum),
         xlab = "",
         ylab = "Noches (millones)",
         main = "Figura 3. Pernoctaciones") +
  scale_x_continuous(breaks= seq(2000, 2020, 2)) 
```

\

## Estacionalidad

Veamos ahora como varían las pernoctaciones de los turistas extranjeros en España según el mes del año. 

```{r}
ggmonthplot(Pernoctaciones, 
             polar=TRUE,
             xlab = "",
             ylab = "",
             main = "Figura 4. Gráfico estacional: pernoctaciones") +
  guides(colour=FALSE)
```

Cada subserie en la figura 4 vuelve a mostrar la evolución de la tendencia durante el periodo de análisis. Respecto de la estacionalidad, se aprecia que el principal determinante son las vacaciones estivales puesto que el número de pernoctaciones aumenta progresivamente desde mayo a agosto para luego caer bruscamente en septiembre. También cabría esperar un efecto _días del mes_ y observar más pernoctaciones en los meses de 31 días que en los de 30, pero el efecto de la vacaciones estivales es tan dominante que anula cualquier otro efecto.

La mayor irregularidad observada en abril puede deberse a si la Semana Santa ha caído en abril o en marzo. 

\
\

# Descomposición

Vamos a obtener cada una de las componentes de la serie usando el método de medias móviles `decompose`. Se ha optado por este método dado que la serie muestra un esquema multiplicativo. Otra opción hubiera sido usar el método de regresiones locales ponderadas trabajando con el logaritmo de la serie, pero entonces hubiéramos perdiendo interpretabilidad.

```{r, fig.height=7}
PernoctacionesDesMul <- decompose(Pernoctaciones, type = "mult")
autoplot(PernoctacionesDesMul,
         xlab = "",
         main = "Figura 5. Descomposición multiplicativa por medias móviles")
```

La __tendencia__ obtenida tras la descomposición no hace sino confirmar lo ya observado, una tendencia decreciente en la primera década, y creciente desde entonces hasta los dos últimos años.

También se aprecian muy claramente varios valores atípicos en el __residuo__ destacando uno en 2005 y varios en los últimos años.

Respecto de la __componente estacional__, se confirma el análisis preliminar: mayor número de pernoctaciones a finales de primavera y verano, especialmente en agosto, y un menor número en invierno, especialmente en diciembre --un mes en que la gente no realiza tantos viales al extranjero. En concreto, en agosto se detecta un 91% más de pernoctaciones respecto de la media anual y en julio un 77% más. Por contra, en diciembre se observa un descenso del 33%, similar al de noviembre. Cabría preguntarse las causas del repunte en marzo, aunque puede deberse a ser un mes de 31 días, comparado con febrero, en el que ocasionalmente cae la Semana Santa.

```{r}
round(PernoctacionesDesMul$figure, 2)
```

A fin de aislar de la componente estacional el efecto _días del mes_ del efecto de las vacaciones estivales, se ha aplicado la descomposición a la serie _pernoctaciones por día_ resultante de dividir la serie original por el número de días del mes (que obtenemos con la función `monthdays`). En esta nueva serie todo el efecto estacional se deberá a las vacaciones de verano.

La figura 6 muestra que la componente estacional estimada para las pernoctaciones por día es solo algo más suave que la componente obtenida a partir la serie original. También se aprecia que el efecto del tamaño del mes es muy acusado en febrero. Para este mes el efecto estacional es el resultado de dos fuerzas, no ser un periodo vacacional y el tamaño del mes (28 días), en la misma dirección que decrementan la componente estacional. Sobre la serie original ambas fuerzas tienen lugar y el resultado es una componente estacional para febrero menor que la de marzo. En la serie de pernoctaciones por día el efecto número de días del mes ha sido eliminado, solo queda el efecto _vacacional_ que es similar para febrero y marzo y por eso la componente de febrero es similar a la de marzo.


```{r}
PernoctacionesDiaDesMul <- decompose(Pernoctaciones/monthdays(Pernoctaciones), type = "mult")

ggplot() +
  geom_line(aes(x = 1:12, y = PernoctacionesDesMul$figure, colour = "black")) + 
  geom_line(aes(x = 1:12, y = PernoctacionesDiaDesMul$figure, colour = "red")) + 
  geom_hline(yintercept = 1, colour = "blue", lty = 2) +
  ggtitle("Figura 6. Componente estacional de pernoctaciones") +
  xlab("") +
  ylab("Efecto estacional") +
  scale_x_continuous(breaks= 1:12, 
                     labels = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", 
                                "Jul", "Ago", "Sep", "Oct", "Nov", "Dic")) +
  scale_color_discrete(name = "Componente estacional", 
                       labels = c("Pernoctaciones", "Pernoctaciones por día")) +
  theme(legend.position=c(0.02,0.98), legend.justification=c(0,1))
```

\
\

# Identificación de meses atípicos

En la descomposición, el vector de residuos contiene las componentes del error y la intervención. Vamos a realizar un análisis gráfico informal del residuo que nos permite ir identificando posibles intervenciones.

Como la descomposición es multiplicativa, el error es en tanto por uno y tiene media 1. Para analizar las propiedades del residuo, vamos a calcularlo como error aditivo. Para ello vamos a restar a la serie original la serie estimada, obtenida como el producto de la tendencia por la estacionalidad, es decir, $R_t = y_t - (T_t * S_t)$.

La figura 7 muestra el error y los intervalos de confianza (IC) al 95% (líneas en verde) y al 99.7% (líneas en rojo). Se observa un valor claramente extremo que cruza el IC(99.7%) por la parte inferior de la gráfica. Es agosto de 2001, mes en el que las pernoctaciones fueron muy inferiores a lo esperado. También se observan otros valores atípicos, en los que el error supera las 2.5 desviaciones típicas: agosto y octubre de 2000 y mayo de 2018. 

```{r}
error <- Pernoctaciones - trendcycle(PernoctacionesDesMul) * seasonal(PernoctacionesDesMul)

sderror <- sd(error, na.rm = TRUE)

autoplot(error,
         xlab = "",
         ylab = "Error",
         main = "Figura 7. Error + Intervención",
         colour = "black") +
  geom_hline(yintercept = c(3, 2, -2, -3)*sderror, 
             colour = c("red", "green", "green", "red"),
             lty = 2) + 
  scale_x_continuous(breaks= seq(1980, 2018, 4)) 
```

