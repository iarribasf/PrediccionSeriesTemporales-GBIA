---
title: "Análisis de la serie Pasajeros en transporte urbano"
subtitle: "Predicción con datos temporales (BIA)"
author: "Iván Arribas (Depto. Análisis Económico. Universitat de València)"
output: 
  html_document:
    theme: cerulean
    highlight: pygments 
    fig_caption: false
    df_print: kable
    toc: true
    toc_depth: 2
    toc_float: 
      collapsed: true
    number_sections: true
    self_contained: true
    code_download: true
---

```{r chunk_setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE, 
                      comment = "",
                      fig.align = "center", 
                      fig.show = "hold",
                      fig.height = 4,
                      fig.width = 8,
                      out.width = "80%") 
```

```{r options_setup, echo = FALSE}
options(scipen = 999) #- para quitar la notacion cientifica
```


En este curso hemos aprendido a describir una serie temporal, estimar su proceso generador de datos y realizar predicciones, tanto puntuales como por intervalo. Para ello, hemos estudiado los principales aspectos teóricos relacionados con las series temporales, sus componentes, criterios de bondad de ajuste y predicción, modelos de ajuste, etc. También hemos practicado la aplicación de estos conceptos a través de diferentes series temporales: Títulos publicados, Nacimientos, Aforo de vehículos, Consumo de alimentos per cápita, Producción de chocolate, Pernoctaciones de turistas extranjeros, entre otras.

El programa de estadística utilizado, `R`, ha servido con dos propósitos entremezclados durante el curso. En primer lugar, para ilustrar los aspectos teóricos que se iban introduciendo. En este caso, `R` tenía un uso más instrumental y en general se mostraba la salida obtenida sin enseñar el código. Sin embargo, el propósito principal ha sido aprender como usar `R` con el objetivo de analizar y predecir una serie temporal. El ejemplo transversal utilizado durante el curso de _Pernoctaciones en alojamientos turísticos de turistas extranjeros_ es el principal exponente de este uso de `R`. 

Ahora bien, ambos usos de `R`, ilustrar aspectos teóricos y analizar una serie, han quedado distribuidos a lo largo de los temas vistos. El ejemplo __Pasajeros en transporte urbano__, desarrollado aquí, tiene como objetivo disponer en un único documento y de forma organizada del análisis completo de una serie temporal. En este informe se mostrará siempre el código completo empleado para las salidas, se hará hincapié en la aplicación práctica de los conceptos teóricos, se insistirá en los diferentes enfoques que se pueden y deben emplear para analizar una serie temporal y se justificarán todas las decisiones adoptadas.

Este es, por tanto, un ejemplo que se extiende más allá de lo que un informe de análisis de una serie temporal precisa.

Para el código de este ejemplo se utilizarán funciones de las librerías básicas de `R` y de otras que se pueden encontrar en las siguientes librerías:

```{r}
library(gridExtra)
library(aod)
library(forecast)
library(ggplot2); theme_set(theme_bw())
library(seasonal)
library(knitr)
library(timeDate)
```


# Pasajeros en transporte urbano

La serie que se va a analizar corresponde al número de pasajeros en transporte urbano en España. Es una serie mensual que puede ser consultada en el [Instituto Nacional de Estadística](\http://www.ine.es) y para la que se dispone de datos desde enero de 1996 hasta diciembre de 2019.

Por transporte urbano de pasajeros se hace referencia a los servicios de transporte terrestre de pasajeros, urbano y suburbano, por itinerarios regulares, con horario establecido y con paradas fijas, realizados por autobuses, tranvías, trolebuses, metros y metros ligeros. También se incluyen las líneas de servicio al aeropuerto y a las estaciones y la explotación de funiculares y teleféricos si forman parte de los sistemas de tránsito urbanos e interurbanos.

Los datos de la serie, que denominaremos de forma abreviada Pasajeros, han sido descargados en el fichero _Pasajeros.csv_ y aunque en origen la unidad es miles de pasajeros, la cambiaremos a millones de pasajeros.

```{r}
meses <- c("Ene", "Feb", "Mar", "Abr", "May", "Jun", 
           "Jul", "Ago", "Sep", "Oct", "Nov", "Dic")

Pasajeros <- read.csv2("./series/Pasajeros.csv", header = TRUE)
Pasajeros <- ts(Pasajeros/1000, start = 1996, freq = 12)
```


# Descriptiva

La figura 2.1 muestra la evolución de la serie Pasajeros en transporte urbano desde 1996 hasta 2019. Destaca que la tendencia de la serie ha seguido el ciclo económico. Durante el periodo de crecimiento de finales del siglo pasado y principios de este, el número de pasajeros en transporte urbano creció de forma sostenida. Con la crisis económica iniciada a finales de 2007 se observa un cambio en la tendencia y el número de pasajeros se reduce. No es hasta el final de la crisis en 2014 que la tendencia vuelve a cambiar y pasar a ser creciente de nuevo.

````{r}
autoplot(Pasajeros, colour = "darkblue",
         xlab = "",
         ylab = "Millones de pasajeros",
         main = "Figura 2.1. Pasajeros en transporte urbano (datos mensuales)") +
  scale_x_continuous(breaks= seq(1996, 2019, 2)) 
```

La serie presenta una acusada estacionalidad, causada principalmente por la distribución de las vacaciones a lo largo de un año y el número de días laborables de cada mes. Pensemos que el principal uso del transporte urbano es el traslado hasta y desde el lugar de trabajo, seguido del ocio (ir de compras, al cine, a restaurantes, etc.). Así, cada año el mes con menor número de pasajeros es agosto (los valles en la figura 2.1) por estar la mayoría de la gente de vacaciones, fuera de sus ciudades de residencia habituales, y no usar tan intensamente el transporte urbano.

El esquema parece ser aditivo porque no se aprecia que la amplitud estacional se amplíe conforme el número de pasajeros aumenta.

En los siguientes epígrafes se hará una descriptiva de la tendencia y la estacionalidad más detallada. 

\

## Análisis de la tendencia

Si anualizamos la serie podemos, por un lado, identificar mejor en que años se producen los cambios en la tendencia y, por otro lado, poner cifras al volumen de pasajeros en transporte urbano.

```{r}
PasajerosAnual <- aggregate(Pasajeros, FUN = sum)
autoplot(PasajerosAnual, colour = "darkblue",
         xlab = "",
         ylab = "Millones de pasajeros",
         main = "Figura 2.2. Pasajeros en transporte urbano (datos anuales)") +
  scale_x_continuous(breaks= seq(1996, 2019, 2))
```

La figura 2.2 muestra el volumen anual de pasajeros en transporte urbano. El crecimiento continuado, posiblemente iniciado antes de 1996 y que permitió superar los 3,000 millones de pasajeros en 2007, se ve interrumpido con el inicio de la pasada crisis económica. La caída irregular en el número de pasajeros se interrumpe en 2014, año que marca la salida de la crisis económica y el inicio de la recuperación en el serie. Actualmente se han superado los 3,100 millones de pasajeros.

El incremento en el uso del transporte urbano observado antes y después de la crisis puede tener distintas causas: un uso más intensivo del transporte urbano en detrimento de otros medios de transporte, una reorganización de los servicios de transporte urbano que haya mejorado la conectividad dentro de los municipios, o un aumento en el número de líneas de autobús, tranvía o metro en determinadas ciudades.

No está clara la causa del repunte aislado observado el año 2011, en plena crisis, pero puede deberse a una ligera recuperación en la economía que tuvo lugar a finales de 2010 y principios de 2011.

\

## Análisis de la estacionalidad

La principal causa de la estacionalidad observada en la serie es la estructura vacacional de la sociedad, especialmente caracterizada por las vacaciones de verano (julio a septiembre) y las vacaciones de Semana Santa (en marzo y/o abril, según el año). Además, debido a que el transporte urbano se usa principalmente para ir a trabajar, también influye el número de días laborables del mes. Por ejemplo, en 2017 el mes de junio tuvo 22 días laborables, mientras que en 2019 tuvo 20 días laborables. Esta diferencia de dos días tendrá un efecto sobre el volumen de pasajeros.

El número de días laborables de un mes viene marcado por los fines de semana del mes y por las festividades nacionales. Es cierto que el sábado se trabaja en diversos sectores (transporte, ocio, distribución) pero la caída en el número de trabajadores respecto de los días entre semana (lunes a viernes) es muy notable. También es cierto que, además de las festividades nacionales, hay muchas festividades autonómicas o municipales que podrían afectar al volumen de pasajeros en transporte urbano. Por ejemplo, las festividades regionales en comunidades como Madrid o Cataluña pueden tener un efecto significativo sobre la serie Pasajeros. Sin embargo, las festividades no nacionales no se van a tener en cuenta.

Por tanto, para realizar un análisis detallado de la estacionalidad, es necesario crear una serie con el número de días laborables de cada mes. Además, esta serie se usará más adelante para modelizar y predecir la serie Pasajeros.

### Días laborables de cada mes {-}

La librería `timeData` proporciona una serie de funciones que permiten definir un calendario de festividades, identificar los fines de semana y, a partir de aquí, crear la serie de días laborables (véase código más abajo).

* Con `timeCalendar` se definen las _consideradas_ festividades nacionales: Año nuevo (1 de enero), Reyes (6 de enero), Viernes Santo (fecha variable), Día del Trabajo (1 de mayo), Día de la Asunción (15 de agosto), Día de la Hispanidad (12 de octubre), Día de Todos los Santos (1 de noviembre), la Constitución (6 de diciembre) la Inmaculada Concepción (8 de diciembre) y Navidad (25 de diciembre). 

  Por claridad, cada festivo se ha definido de forma independiente para después crear una variable con todas las festividades (_FestivosNacionales_).

  El rango para todos los cálculos va desde 1996 hasta 2024, que incluye el rango de la serie Pasajeros más cinco años de predicción.

  La función utilizada `Easter` de la librería `timeDate` difiere de la función `easter` de `forecast`.

* A continuación, con `timeSequence` se crea una serie diaria desde el 1 de enero de 1996 hasta el 31 de diciembre de 2024.

* Las dos siguientes líneas eliminan de la serie diaria los festivos y los fines de semana, (función `isBizday`), para después dar a esta nueva serie el formato año-mes eliminando el día. De esta forma, la serie de días laborales tendrá el mismo identificador para todos los días del mismo mes.

* Después, se crea una tabla que, por la naturaleza de la serie de días laborales, tendrá para cada año-mes el numero de días laborables. Por último fechamos la tabla, que es nuestra serie de días laborables y mostramos algunos datos.

* Las dos últimas líneas de código dividen la serie en el periodo muestral y el de predicción.

\

```{r}
AnoNuevo <- timeCalendar(d = 1, m = 1, y = 1996:2024)
Reyes <- timeCalendar(d = 6, m = 1, y = 1996:2024)
ViernesSanto <- Easter(1996:2024, shift = -2)
DiaTrabajo <- timeCalendar(d = 1, m = 5, y = 1996:2024)
Asuncion <- timeCalendar(d = 15, m = 8, y = 1996:2024)
Hispanidad <- timeCalendar(d = 12, m = 10, y = 1996:2024)
TodoSantos <- timeCalendar(d = 1, m = 11, y = 1996:2024)
Constitucion <- timeCalendar(d = 6, m = 12, y = 1996:2024)
Inmaculada <- timeCalendar(d = 8, m = 12, y = 1996:2024)
Navidad <- timeCalendar(d = 25, m = 12, y = 1996:2024)

FestivosNacionales <- c(AnoNuevo, Reyes, ViernesSanto,
                        DiaTrabajo, Asuncion,  Hispanidad, TodoSantos, 
                        Constitucion, Inmaculada, Navidad)

fechaDiaria <- timeSequence(from = "1996-01-01", to = "2024-12-31")
biz <- fechaDiaria[isBizday(fechaDiaria, holidays = FestivosNacionales)]
bizdays <- format(biz, format = "%Y-%m")

DiasLaborables <- table(bizdays)
DiasLaborables <- ts(DiasLaborables, start = 1996, frequency = 12)

subset(DiasLaborables, start = 289) #Mostramos solo los 5 últimos años

pDiasLaborables <- subset(DiasLaborables, start = length(DiasLaborables) - 59)
DiasLaborables <- subset(DiasLaborables, end = length(DiasLaborables) - 60)
```

Es conveniente indicar que la identificación de las festividades nacionales dista de ser perfecta por varios motivos:

* algunos festivos nacionales, si caen en domingo, se pasan a lunes (por ejemplo Reyes y la Inmaculada de 2019), aspecto que no se ha tenido en cuenta.
* algunos festivos nacionales pueden ser sustituidos por otros días por las Comunidades Autónomas, por ejemplo Reyes o Jueves Santo.

\

### Análisis gráfico de la estacionalidad {-}

Veamos ahora una descriptiva detallada de la estacionalidad de la serie Pasajeros, haciendo especial hincapié en el efecto de las vacaciones (verano y Semana Santa) y el número de días laborables. Para ello, mostraremos gráficamente las subseries definidas por el mes tanto para Pasajeros como para _Pasajeros por día laborable_, esta segunda resultado de dividir Pasajeros por DiasLaborables.

```{r, fig.height = 5}
PasajerosDL <- Pasajeros/DiasLaborables

g1 <- ggsubseriesplot(Pasajeros) +
  ylab("Millones de pasajeros") +
  xlab("") +
  ggtitle("Figura 2.3a. Gráfico estacional para Pasajeros")

g2 <- ggsubseriesplot(PasajerosDL) +
  ylab("Millones de pasajeros") +
  xlab("") +
  ggtitle("Figura 2.3b. Gráfico estacional para Pasajeros por día laboral")

grid.arrange(
  grobs = list(g1, g2),
  ncol = 1
)
```
Las figuras 2.3a y 2.3b muestran para cada mes la serie de pasajeros (total o por día laborable) y el valor medio (línea azul horizontal). En ambos casos se identifica perfectamente el efecto de los periodos vacacionales sobre el transporte urbano de pasajeros. En las vacaciones de verano se observa una fuerte caída en el número de pasajeros, especialmente en agosto y, en menor medida, en julio y septiembre. Por otro lado, las subseries de marzo y abril muestran mucha más irregularidad que las de otros meses debido a que el volumen de pasajeros depende de cómo ha caído la Semana Santa. Si un año esta cae en marzo, ese mes presentará un volumen de pasajeros inferior al de los meses de marzo sin Semana Santa, mientras que en abril se dará el efecto contrario. Diciembre, para ser un mes de 31 días, presenta también un reducido número de pasajeros debido a las vacaciones navideñas.

La figura 2.3a muestra el efecto estacional total debido al número de días del mes y de días laborales. Por ejemplo, en febrero, el mes con menos días y por tanto con menos días laborales, en media se transportan menos pasajeros, comparado con enero o marzo. Octubre, un mes con 31 días, muestra un volumen medio de pasajeros mayor que noviembre de 30 días.

En la figura 2.3b se ha eliminado el efecto de los días laborables al trabajar con la serie de pasajeros transportados por día laborable. Si la comparamos con la figura 2.3a, destaca que las diferencias entre las medias (lineas azules) se han reducido: prácticamente no hay diferencias entre los meses de enero a junio, o entre los meses de octubre a diciembre.

Cabe pensar que al excluir de la serie de días laborables la Semana Santa, en la figura 2.3b las subseries de marzo y abril deberían ser tan suaves como las observadas para otro meses, pero no es así. Claramente la simple exclusión de los festivos nacionales de Semana Santa no es suficiente para recoger bien su efecto sobre el transporte urbano. La razón hay que buscarla en las vacaciones escolares de este periodo, que en algunas comunidades autónomas tiene lugar durante la propia semana de Semana Santa, mientras que en otras comunidades tiene lugar en la semana posterior. De esta forma, el efecto sobre el transporte urbano de Semana Santa no es homogéneo en el territorio nacional y resulta difícil incluirlo en el análisis de la serie Pasajeros. Cuando se analice la serie por modelos Arima será conveniente recordar este hecho.

\

### Análisis numérico de la estacionalidad {-}

Podemos obtener la componente estacional de forma sencilla para poder valorar numéricamente el efecto estacional y ver que efecto tiene el número de días laborables. Previamente, debemos determinar el esquema, aditivo o multiplicativo, de la serie.

La gráfica media-desviación típica (figura 2.4) refuerza la impresión que se obtenía de la gráfica de la serie (figura 2.1), que el esquema es aditivo.

```{r}
MediaAnual = as.numeric(aggregate(Pasajeros, FUN = mean))
DesviacionAnual = as.numeric(aggregate(Pasajeros, FUN = sd))

ggplot() +
  geom_point(aes(x = MediaAnual, y = DesviacionAnual), size = 2) +
  xlab("Media de pasajeros por año") + 
  ylab("Desviación típica de pasajeros por año") + 
  ggtitle("Figura 2.4. Identificación del tipo de esquema")
```

```{r}
PasajerosMedia <- tapply(Pasajeros - mean(Pasajeros), 
                         cycle(Pasajeros), 
                         mean)
PasajerosDLMedia <- tapply((PasajerosDL - mean(PasajerosDL)), 
                           cycle(PasajerosDL), 
                           mean)

datos <- cbind(PasajerosMedia, PasajerosDLMedia)
colnames(datos) <- c("Pasajeros", "Pasajeros por día laborable")
rownames(datos) <- meses

kable(datos, 
      digits = 2,
      caption = "Efecto estacional")
```

La tabla 1 pone en cifras el efecto estacional sobre los Pasajeros (primera columna): en agosto la caída en el número de pasajeros, respecto de la media anual, se cifra en 72 millones de pasajeros. En julio, septiembre y en menor medida febrero también el uso del transporte urbano es inferior a la media  anual, en el caso de los dos primeros meses por las vacaciones de verano y en febrero debido a ser el mes con menos días del año. Por otro lado, destaca el elevado número de pasajeros en los meses de marzo, mayo y octubre, por tener 31 días, y noviembre, por razones desconocidas.

Tras la corrección por el número de días laborales, el efecto estacional es más suave (véase la segunda columna en la tabla 1). Ahora, los meses de febrero y marzo tienen un efecto similar, al igual que octubre y noviembre. También se observa que las diferencias entre marzo y abril se han reducido enormemente. También el efecto _número de días del mes_ ha desaparecido en gran medida.

\

## Descomposición de la serie

Ya hemos realizado una detallada descripción de las principales componentes de la serie, tendencia y estacionalidad. Ahora vamos a proceder a descomponerla a fin de analizar, aunque sea de forma gráfica, el error y tener ya una primera impresión sobre la relevancia de la componente de intervención en Pasajeros.

Dado que la serie presenta un esquema aditivo, usaremos el método de descomposición por regresiones locales ponderadas, asumiendo una componente estacional constante y considerando la presencia de posibles valores extremos.

```{r}
PasajerosStl <- stl(Pasajeros[,1], s.window = "periodic", robust = TRUE)

error <- remainder(PasajerosStl)
sderror <- sd(error)

autoplot(error,
         xlab = "",
         ylab = "Error",
         main = "Figura 2.5. Error + Intervención",
         colour = "darkblue") +
  geom_hline(yintercept = c(3, 2, -2, -3)*sderror, 
             colour = c("red", "green", "green", "red"),
             lty = 2) + 
  scale_x_continuous(breaks= seq(1996, 2019, 4))
```

La figura 2.5 muestra el error de la descomposición y los intervalos de confianza al 95% (líneas verdes) y el 99.7% (líneas rojas). Se aprecian claramente múltiples valores extremos (superan las tres desviaciones típicas) en forma de _compensación_ (dos errores extremos consecutivos de signo opuesto) que corresponden a los meses de marzo y abril de 1997, 2002, 2008 y 2013, y otro valor extremo en abril de 2005. Además, en marzo y abril de 2016 hay dos valores atípicos. Nótese que todos los valores identificados corresponden a los meses de marzo y abril, y en todos los casos el error negativo tiene lugar en marzo y el positivo en abril. Si miramos un calendario veremos que tienen lugar en los años en que Semana Santa cayó en marzo.

Si repetimos este análisis para la serie de Pasajeros por día laborable, los resultados son bien diferentes (véase figura 2.6). Ahora solo se detectan dos valores extremos en diciembre de 2000 y 2006. También destaca el error de diciembre de 2017. Los errores en diciembre se dan cuando Navidad cae en lunes, de forma que la caída en el transporte urbano debida a la nochebuena coincide con la de cualquier domingo. Así, estos meses de diciembre presentan más transporte urbano que los meses de diciembre donde la nochebuena cae entre semana. 

```{r}
PasajerosStl <- stl(PasajerosDL[,1], s.window = "periodic", robust = TRUE)

error <- remainder(PasajerosStl)
sderror <- sd(error)

autoplot(error,
         xlab = "",
         ylab = "Error",
         main = "Figura 2.6. Error + Intervención",
         colour = "darkblue") +
  geom_hline(yintercept = c(3, 2, -2, -3)*sderror, 
             colour = c("red", "green", "green", "red"),
             lty = 2) + 
  scale_x_continuous(breaks= seq(1996, 2019, 4))
```

Para la identificación de los valores extremos se ha hecho uso de las funciones `easter` del paquete `forecast` y `dayOfWeek` del paquete `timeDate`.

\

## Conclusión 

La serie de pasajeros en transporte urbano muestra una tendencia creciente solo interrumpida entre 2008 y 2013 debido a la reciente crisis económica.

Los principales determinantes de la estacionalidad de la serie Pasajeros son los grandes periodos vacacionales en España (Semana Santa y verano) y el número de días laborales del mes. Sin embargo, en la serie Pasajeros corregida por días laborables, la componente estacional se ha suavizado y prácticamente queda determinada por las vacaciones.

La intervención tiene lugar en los meses de marzo y abril debido al carácter móvil de la Semana Santa, y en diciembre cuando el día de Navidad cae en lunes de forma que la caída de pasajeros de nochebuena se solapa con la de cualquier domingo.

\
\

# Un predicción rápida y sencilla

En los siguientes epígrafes aplicaremos técnicas de predicción crecientes en complejidad conceptual y computacional, y que requerirán de más hipótesis para su correcta aplicación. Aunque actualmente más complejidad no siempre implica más recursos (temporales, humanos, informáticos), cabe preguntarse si vale la pena. Así, más por una cuestión teórica que práctica, veamos cual sería la calidad de las predicciones si aplicamos una metodología sencilla, en este caso el método ingenuo con estacionalidad.

```{r, echo = FALSE}
PasajerosSnaive <- snaive(Pasajeros, h = 60)
```

Los indicadores de calidad de ajuste (predicción intra-muestral a un periodo vista) indican que repetir la última observación del mismo mes puede ser suficiente para obtener una buena predicción a corto plazo. En media el error es de `r round(accuracy(PasajerosSnaive)[2], 1)` millones de pasajeros (RMSE), aproximadamente un `r round(accuracy(PasajerosSnaive)[5], 1)`%. A largo plazo, las predicciones pueden perder calidad rápidamente puesto que no capturan ningún tipo de tendencia. La figura 3.1 muestra como la predicción del número de pasajeros para los años 2020 a 2024 se mantiene estacionaria y no refleja la tendencia creciente observada desde 2014.

```{r}
PasajerosSnaive <- snaive(Pasajeros, h = 60)
accuracy(PasajerosSnaive)
autoplot(PasajerosSnaive, 
         PI = FALSE,
         xlab = "",
         ylab = "Millones de pasajeros",
         main = "Figura 3.1. Pasajeros en transporte urbano y predicción.\nMétodo ingenuo con estacionalidad") +
  scale_x_continuous(breaks= seq(1996, 2024, 2))
```

Este será nuestro punto de referencia. Cabe esperar que en los siguientes epígrafes, donde aplicaremos técnicas de Alisado exponencial y modelos Arima, se observe un incremento significativo en la calidad del ajuste.

**Nota**: la Covid-19 ha supuesto un _shock_ de una magnitud inesperada en todos los aspectos de la sociedad española y, en concreto, en los hábitos de transporte urbano. Es por ello que todas las predicciones que aparecen en este ejemplo de aplicación sobre-estimarán enormemente las cifras de transporte reales. Cualquier método de predicción asume que las condiciones del entorno en que se aplica no van a cambiar en el futuro.


\
\

# Alisado exponencial

En primer lugar analizaremos la capacidad predictiva de los métodos de Alisado exponencial sobre la serie Pasajeros. Con este fin, ajustaremos el mejor modelo de alisado y estimaremos los criterios de calidad para el ajuste y las predicciones extra-muestrales según el horizonte temporal. Posteriormente veremos si es posible mejorar las predicciones analizando la transformación logarítmica de Pasajeros y analizando la serie Pasajeros por día laborable.

\

## Análisis de la serie Pasajeros

\

### Estimación e interpretación {-}

El modelo óptimo, estimado con la función `ets` sin imponer ninguna restricción, es ETS(M,Ad,A): pendiente aditiva con amortiguamiento, estacionalidad aditiva y residuo multiplicativo.
  $$y_{t+1} = (l_t + \phi b_t + s_{t+1-m}) \cdot (1 + \varepsilon_{t+1}).$$
```{r}
PasajerosEts <- ets(Pasajeros, model = "ZZZ")
summary(PasajerosEts) 
```

El valor de $\phi=$ `r round(coef(PasajerosEts)[4], 2)` indica que la inclusión de amortiguamiento en el modelo mejora sensiblemente su ajuste a los datos. Por otro lado, $\gamma$ es técnicamente cero, indicando que el efecto estacional se mantiene constante en el tiempo. Sin embargo, el valor de $\beta$, reducido pero no nulo, indica que la pendiente cambia en el tiempo de forma muy lenta.

La calidad del ajuste es bastante buena, con un error porcentual del `r round(accuracy(PasajerosEts)[5], 1)`% o un error de `r round(accuracy(PasajerosEts)[2], 1)` millones de pasajeros (RMSE). La aplicación del método de alisado supone una reducción de un punto en el error porcentual respecto del método ingenuo, o una reducción de 3.5 millones de pasajeros. Es decir, el modelo de alisado exponencial supone una mejora en la calidad del ajuste del `r 100 - round(100*accuracy(PasajerosEts)[6], 0)`% respecto del método ingenuo con estacionalidad visto en el epígrafe previo (MASE).

El efecto estacional, que recordemos se mantiene constante en el tiempo, es prácticamente idéntico al estimado en la descriptiva y viene determinado por los periodos vacacionales y el número de días del mes (y por consiguiente el número de días laborables). Véase la figura 4.1. 

En verano (julio a septiembre) el uso del transporte urbano es inferior a la media anual, destacando agosto con un descenso de 72 millones de pasajeros. A su vez, octubre destaca por ser el mes con mayor incremento en el volumen de pasajeros (27 millones) respecto de la media anual.

```{r}
PasajerosEtsEst <- PasajerosEts$states[nrow(PasajerosEts$states), 14:3]
names(PasajerosEtsEst) <- meses

round(PasajerosEtsEst, 2)

ggplot() +
  geom_line(aes(x = 1:12, y = PasajerosEtsEst), colour = "darkblue") + 
  geom_hline(yintercept = 0, colour = "black", lty = 2) +
  ggtitle("Figura 4.1. Componente estacional estimada con Alisado exponencial") +
  xlab("") +
  ylab("Efecto estacional") +
  scale_x_continuous(breaks= 1:12, 
                     labels = meses)
```

\

### Predicción {-}

Podemos ahora pedir los valores de predicción y su intervalo de confianza al 95% para los próximos cinco años. No mostramos los resultados numéricos, pero si gráficos (figura 4.2). Las predicciones muestran una tendencia creciente amortiguada y, por tanto, no tan acusada como la observada en los años precedentes. 
  
```{r}
PasajerosEtsPre <- forecast(PasajerosEts, h = 60, level = 95)
autoplot(PasajerosEtsPre,
         xlab = "",
         ylab = "Millones de pasajeros",
         main = "Figura 4.2. Pasajeros (1996-2019) y predicción (2020-2024).\nMétodo de alisado exponencial") 
```

En el año 2020 se esperan `r round(sum(PasajerosEtsPre$mean[1:12]), 0)` millones de pasajeros, 
un `r round(100*(sum(PasajerosEtsPre$mean[1:12]) - sum(tail(Pasajeros, 12)))/sum(PasajerosEtsPre$mean[1:12]), 1)`% más que en 2019.

\

### Análisis del error {-}

El residuo del modelo (figura 4.3) muestra varios valores que pueden ser considerados como atípicos y que se dan siempre en los meses de marzo y abril para los años donde la Semana Santa recayó en marzo.

```{r}
error <- residuals(PasajerosEts)
sderror <- sd(error)

autoplot(error,
         xlab = "",
         ylab = "Error",
         main = "Figura 4.3. Error + Intervención. Método de alisado",
         colour = "darkblue") +
  geom_hline(yintercept = c(-3, -2, 2 ,3)*sderror, 
             colour = c("red", "green", "green", "red"), lty = 2) + 
  scale_x_continuous(breaks= seq(1996, 2019, 2))
```

\

## Otras alternativas de análisis

En la descriptiva se ha visto que la serie de pasajeros por día laborable tiene un comportamiento más suave (la componente estacional era más plana) y presentaba un menor número de valores atípicos que la serie original Pasajeros. Cabe esperar, por tanto, que esta serie presente un mejor ajuste con los métodos de alisado exponencial y ofrezca mejores predicciones.

Por otro lado, siempre vale la pena analizar la transformación logarítmica de la serie y ver si ofrece mejores resultados que la serie original. La transformación logarítmica es especialmente eficaz para series no lineales, así que para Pasajeros posiblemente no suponga ningún mejora.

Las transformaciones indicadas en los dos párrafos precedentes son solo dos de las posibles. También se pude analizar la serie de pasajeros por día del mes o la transformación óptima de Box-Cox. La idea es no quedarse con lo inmediato, la serie tal cual nos la han ofrecido, sino probar otras alternativas. Por ejemplo, la serie de Pasajeros es el agregado del número de pasajeros que viajan en transporte urbano según el tipo de transporte (autobús, metro, tranvía...). Se podría proceder a analizar cada serie por separado (pasajeros en autobús, pasajeros en metro, etc.), para luego agregar los resultados y ver si este enfoque da mejores resultados que el análisis directo de la serie agregada Pasajeros.

En este epígrafe se analizarán las dos primeras transformaciones indicadas, la transformación logarítmica y los pasajeros por día laborable. El objetivo es ver si es posible mejorar la calidad de las predicciones obtenidas para Pasajeros. Se usará como criterio de bondad el error de las predicciones extra-muestrales según el horizonte temporal, obtenido con el procedimiento _origen de predicción móvil_. Asumiremos que son necesarios 10 años para obtener una buena estimación del modelo y el horizonte temporal se fijará en 12 meses ($k = 120, h = 12$). Previamente, hay que identificar el mejor modelo para las series transformadas.

```{r}
ets(PasajerosDL)$method
ets(Pasajeros, lambda = 0)$method
```

\

```{r}
k <- 120                 
h <- 12                  
TT <- length(Pasajeros)  
s <- TT - k - h          

mapeAlisadoPas <- matrix(NA, s + 1, h)
mapeAlisadolPas <- matrix(NA, s + 1, h)
mapeAlisadoPasDL <- matrix(NA, s + 1, h)

for (i in 0:s) {
  train.set <- subset(Pasajeros, start = i + 1, end = i + k)
  test.set <-  subset(Pasajeros, start = i + k + 1, end = i + k + h)
  
  trainDL.set <- subset(PasajerosDL, start = i + 1, end = i + k)
  testDL.set <-  subset(PasajerosDL, start = i + k + 1, end = i + k + h)
  
  fit <- ets(train.set, model = "MAA", damped = TRUE)
  fcast <- forecast(fit, h = h)
  mapeAlisadoPas[i + 1,] <- 100*abs(test.set - fcast$mean)/test.set
  
  fit <- ets(train.set, model = "AAA", damped = TRUE, lambda = 0)
  fcast <- forecast(fit, h = h, biasadj = TRUE)
  mapeAlisadolPas[i + 1,] <- 100*abs(test.set - fcast$mean)/test.set
  
  fit <- ets(trainDL.set, model = "MAA", damped = TRUE)
  fcast <- forecast(fit, h = h)
  mapeAlisadoPasDL[i + 1,] <- 100*abs(testDL.set - fcast$mean)/testDL.set
}

errorAlisadoPas <- colMeans(mapeAlisadoPas)
errorAlisadoPasDL <- colMeans(mapeAlisadoPasDL)
errorAlisadolPas <- colMeans(mapeAlisadolPas)

datos <- cbind(1:12, errorAlisadoPas, errorAlisadoPasDL, errorAlisadolPas)
colnames(datos) <- c("Horizonte", "Pasajeros", 
                     "Pasajeros por día laborable", "Pasajeros (log)")

kable(datos, 
      digits = 2,
      caption = "MAPE según serie y horizonte temporal")

datos <- data.frame(
  factor = c(rep("Pasajeros", 12), 
             rep("Pasajeros por día laborable", 12), 
             rep("Pasajeros (log)", 12)),
  x = c(1:12, 1:12, 1:12),
  y = c(errorAlisadoPas, errorAlisadoPasDL, errorAlisadolPas)
)

ggplot(datos, aes(x = x, y = y,  colour= factor)) + 
  geom_line() +
  ggtitle("Figura 4.4. Error de predicción (MAPE) según horizonte temporal y enfoque") +
  xlab("Horizonte temporal de predicción") +
  ylab("%") +
  scale_x_continuous(breaks= 1:12) +
  scale_y_continuous(breaks= seq(2.6, 4, .2)) +
  guides(colour = guide_legend(title = "Métodos")) + 
  theme(legend.position=c(0.02,0.98), legend.justification=c(0,1))
```

Antes de pasar al análisis de los resultados, indicar que en las predicciones sobre el logaritmo se ha pedido corrección por sesgo (`biasadj = TRUE`), y que al trabajar con errores porcentuales no es necesario pasar la predicción de pasajeros por día laborable a predicción de pasajeros.

El todos los casos el error aumenta con el horizonte temporal de predicción, de forma que las predicciones a doce meses vista tienen un error un punto porcentual superior a las predicciones a un mes vista. (Véase tabla 2)

Por otro lado, con independencia del horizonte temporal, las predicciones realizadas sobre la serie original Pasajeros son las más ajustadas, seguidas de las predicciones realizadas sobre su transformación logarítmica. En contra de lo esperado, la predicción a partir de la serie de pasajeros por día laborable es la que mayor error porcentual presenta, en media 0.25% puntos por encima del error de predicción de Pasajeros. (Véase figura 4.4.)

\

## Conclusión

Los modelos de Alisado exponencial resultan excelentes para predecir la serie Pasajeros. El error de ajuste, del `r round(accuracy(PasajerosEts)[5], 1)`%, es un punto inferior al error obtenido con el método ingenuo con estacionalidad. Además, en las predicciones extra-muestrales a 12 meses vista el error porcentual sigue manteniéndose bajo, no superando el 4%.

Ningún enfoque alternativo probado para la predicción del número de pasajeros por métodos de alisado ha dado mejores resultados que el análisis directo de la serie.

\
\


# Modelos Arima

La aplicación de la metodología Arima a la serie Pasajeros implica un notable incremento en la complejidad de los modelos y en los requerimientos estadísticos, que solo está justificada si se reduce adecuadamente el error de predicción.

En los epígrafes previos hemos visto que la serie Pasajeros tiene una componente de intervención muy acusada, destacando el número de días del mes, el de días laborables, el fechado de la Semana Santa y que el día de Navidad caiga en lunes. Cabe espera, por tanto, que la incorporación de estos efectos calendario en el análisis de la serie incremente significativamente la calidad de ajuste y la capacidad predictiva. Veamos si es así.

\

## Transformación de la serie Pasajeros

Por un lado, el análisis por Alisado exponencial ha puesto de relieve el carácter lineal de Pasajeros y la poca efectividad que tiene usar la transformación logarítmica para mejorar la calidad de las predicciones.

Por otro lado, tras un análisis preliminar por modelos Arima hemos visto que la transformación logarítmica mejoraba la identificación del modelo y facilitaba su interpretación.

Ante esta situación, hemos optado por identificar la transformación logarítmica de Pasajeros.

Las FAC del logaritmo de la serie y algunas de sus diferenciaciones (figura 5.1) indican que es necesaria la doble diferenciación regular y estacional para alcanzar las hipótesis de estacionariedad y ergodicidad: $\log(Pasajeros) \sim I(1)I_{12}(1)$. Los resultados ofrecidos por las funciones `ndiffs` y `nsdiffs` apoyan esta conclusión.

```{r, fig.height = 5}
grid.arrange(
  ggAcf(log(Pasajeros), lag = 72, main = "Figura 5.1. FAC para Pasajeros (log)", 
        xlab = "", ylab = expression(log(y[t]))),
  ggAcf(diff(log(Pasajeros)), lag = 72, main = "", 
        xlab = "", ylab = expression(nabla*log(y[t]))),
  ggAcf(diff(log(Pasajeros), lag = 12),lag = 72, main = "", 
        xlab = "", ylab = expression(nabla[12]*log(y[t]))),
  ggAcf(diff(diff(log(Pasajeros), lag=12)), lag = 72, main = "", 
        xlab = "", ylab = expression(nabla*nabla[12]*log(y[t]))),
  nrow = 2
)
```

```{r}
ndiffs(log(Pasajeros))
nsdiffs(log(Pasajeros))
```

La figura 5.2 muestra la serie original $y_t$ y la serie transformada $\nabla \nabla_{12} \log(y_t)$. En la serie transformada destacan las compensaciones asociadas a la intervención de Semana Santa.

```{r}
series <- cbind("Original" = Pasajeros,
                "Dif reg. y est. de log" = diff(diff(log(Pasajeros), lag = 12)))
autoplot(series, facets = TRUE,
         xlab = "",
         ylab = "",
         main = "Figura 5.2. Pasajeros ")
```

\

## Identificación de la serie Pasajeros

Vamos a identificar los valores de $p$, $q$, $P$ y $Q$ del proceso Arima. Para ello, solicitaremos con `auto.arima` y `seas` una identificación automática, en el primer caso incluyendo todos los efectos calendario ya identificados.


\

### Identificación automática con `auto.arima` {-}

Para _ayudar_ a la función `auto.arima` en el proceso de identificación vamos a definir previamente todas las variables de intervención que en el desarrollo del análisis de la serie hemos ido identificando: días del mes, días laborables del mes, meses de diciembre con el día de Navidad en lunes y Semana Santa:

* La variables _días laborables del mes_ ya ha sido definida previamente como DiasLaborables.
* La variable _Días del mes_ se puede definir directamente con la función `monthdays` de la librería `forecast`. En lugar de días del mes, consideraremos la variable _días no laborables del mes_, resultante de restar a los días del mes los días laborables.
* Los meses de diciembre en que el día de Navidad cae en lunes requiere un poco más de trabajo. La idea general es generar un rango de fechas diarias que cubra todo el periodo de análisis (variable _fechas_), identificar los lunes de Navidad (variable dicotómica _lunesNavidad_), eliminar el identificador del día del rango de fechas con la función `format` y, por último, con `tapply` sumar para cada mes-año los lunes de Navidad, que lógicamente solo tendrán lugar algunos meses de diciembre y una sola vez. En los objetos definidos con la función `as.POSIXlt` los meses van de 0 a 11 (enero a diciembre) y los días de la semana de 0 a 6 (domingo a sábado).
* La creación de las variables de intervención que estiman el efecto de la Semana Santa es aún más complejo. El efecto del viernes de Semana Santa ya queda recogido en la variable DiasNoLaborables. Lo que vamos a hacer ahora es crear una variable que permita estimar el efecto de las vacaciones escolares (y de muchos padres y madres) de lunes a Jueves Santo en aquellas comunidades donde así es; y otra variable para estimar el efecto de las vacaciones escolares que tienen lugar la semana posterior al Domingo de Resurrección, de lunes a viernes tras Semana Santa. Estas nuevas variables (_DiasPreSanta_ y _DiasPascua_) valdrán cero para los meses distintos de marzo y abril, pero para marzo valdrán la proporción de días vacacionales que recaen en marzo y para abril el opuesto (la proporción de días vacacionales que no caen el abril). Es decir, se genera un efecto compensación siempre que un periodo vacacional no recae íntegramente en abril y la magnitud de esta compensación es proporcional a la proporción de días vacacionales fuera de abril.


```{r}
DiasNoLaborables <- monthdays(Pasajeros) - DiasLaborables
pDiasNoLaborables <- monthdays(PasajerosEtsPre$mean) - pDiasLaborables

fechas <- as.POSIXlt(seq(from = as.Date("1996-1-1"), 
                         to = as.Date("2024-12-31"), 
                         by = 1))
LunesNavidad <- 1*(fechas$wday == 1 & fechas$mon == 11 & fechas$mday == 25)
fechas <- format(fechas, format = "%Y-%m")
LunesNavidad <- tapply(LunesNavidad, fechas, sum)
LunesNavidad <- ts(LunesNavidad, start = 1996, frequency = 12)
pLunesNavidad <- subset(LunesNavidad, start = length(LunesNavidad) - 59)
LunesNavidad <- subset(LunesNavidad, end = length(LunesNavidad) - 60)
LunesNavidad[LunesNavidad == 1]

LunSanto <- Easter(1996:2024, shift = -6)
MarSanto <- Easter(1996:2024, shift = -5)
MieSanto <- Easter(1996:2024, shift = -4)
JueSanto <- Easter(1996:2024, shift = -3)

PreSanta <- c(LunSanto, MarSanto, MieSanto, JueSanto)
biz <- fechaDiaria[isBizday(fechaDiaria, holidays = PreSanta, wday = 0:6)]
bizdays <- format(biz, format = "%Y-%m")

DiasPreSanta <- table(bizdays)
DiasPreSanta <- ts(DiasPreSanta, start = 1996, frequency = 12)
DiasPreSanta <- (monthdays(DiasPreSanta) - DiasPreSanta)/4
DiasPreSanta[cycle(DiasPreSanta) == 4] <- -DiasPreSanta[cycle(DiasPreSanta) == 3]  

pDiasPreSanta <- subset(DiasPreSanta, start = length(DiasPreSanta) - 59)
DiasPreSanta <- subset(DiasPreSanta, end = length(DiasPreSanta) - 60)

LunPascua <- Easter(1996:2024, shift = 1)
MarPascua <- Easter(1996:2024, shift = 2)
MiePascua <- Easter(1996:2024, shift = 3)
JuePascua <- Easter(1996:2024, shift = 4)
ViePascua <- Easter(1996:2024, shift = 5)

Pascua <- c(LunPascua, MarPascua, MiePascua, JuePascua, ViePascua)
biz <- fechaDiaria[isBizday(fechaDiaria, holidays = Pascua, wday = 0:6)]
bizdays <- format(biz, format = "%Y-%m")

DiasPascua <- table(bizdays)
DiasPascua <- ts(DiasPascua, start = 1996, frequency = 12)
DiasPascua <- (monthdays(DiasPascua) - DiasPascua)/5
DiasPascua[cycle(DiasPascua) == 4] <- -DiasPascua[cycle(DiasPascua) == 3]  

pDiasPascua <- subset(DiasPascua, start = length(DiasPascua) - 59)
DiasPascua <- subset(DiasPascua, end = length(DiasPascua) - 60)

autoplot(DiasPreSanta, series="Pre Semana Santa",
         xlab = "",
         ylab = "Proporción de días en marzo",
         main = "Figura 5.3. Intervención para periodos vacacionales de Semana Santa") +
  autolayer(DiasPascua, series="Post Semana Santa") +
  scale_colour_manual(values=c("Pre Semana Santa"="black","Post Semana Santa"="red"),
                      breaks=c("Pre Semana Santa","Post Semana Santa"))
```

La figura 5.3 muestra las dos variables de intervención de Semana Santa, que para algunos años se superponen.

Ahora tenemos todos los elementos para pedir la identificación automática con `auto.arima`.

```{r}
auto.arima(Pasajeros, 
           lambda = 0,
           d = 1, 
           D = 1,
           xreg = cbind(DiasLaborables, DiasNoLaborables, 
                        LunesNavidad, DiasPreSanta, DiasPascua))
```

La identificación automática muestra el proceso de las aerolíneas. Además, parece que todas las variables de intervención con significativas.

\

### Identificación automática con `seas` {-}

La función `seas` de `seasonal` incluye automáticamente durante la identificación las variables de intervención necesarias.

```{r}
summary(seas(log(Pasajeros)))
```

En este caso el proceso identificado en la parte regular es más complejo que el obtenido con `auto.arima`, ARIMA(3,1,1). Además, se han incluido variables de intervención asociadas a los años bisiestos, la Semana Santa y días laborables. Conjuntamente estas variables de intervención recogen los mismos efectos considerados por nosotros.


Concluimos que el modelo de partida para Pasajeros será $\log(Pasajeros) \sim ARIMA_{12}(0, 1, 1)(0, 1, 1) + AI$.

\

## Estimación del modelo e identificación de otras componentes de intervención

Vamos a estimar el modelo identificado y a analizar la presencia de otros valores atípicos en el residuo.

```{r}
PasajerosAri <- Arima(Pasajeros, 
                      lambda = 0,
                      order = c(0, 1, 1),  
                      seasonal = list(order = c(0, 1, 1), period = 12),
                      xreg = cbind(DiasLaborables, DiasNoLaborables, 
                                   LunesNavidad, DiasPreSanta, DiasPascua))
PasajerosAri

error <- residuals(PasajerosAri)
sderror <- sd(error)

autoplot(error, series="Error",
         colour = "black",
         xlab = "",
         ylab = "Error",
         main = "Figura 5.4. Error + Intervención. Modelo ARIMA") +
  geom_hline(yintercept = c(-3, -2, 0, 2, 3)*sderror, 
             colour = c("red", "blue", "black", "blue", "red"), 
             lty = 2) + 
  scale_x_continuous(breaks= seq(1996, 2019, 2))
```

Identificamos tres meses en los que el error supera o casi alcanza las tres desviaciones típicas y son candidatos a valores atípicos: abril de 2002, agosto de 2005 y marzo de 2010. No es fácil conocer las causas para estos valores atípicos.

Tras incluir las correspondientes variables artificiales en el modelo y estimarlo, identificamos otro valor extremo en agosto de 2006 y precedimos a incluirlo en el modelo y repetir el análisis. En esta ocasión ya no identificamos más valores atípicos.

```{r}
d0402 <- 1*(trunc(time(Pasajeros)) == 2002 & cycle(Pasajeros) == 4)
d0805 <- 1*(trunc(time(Pasajeros)) == 2005 & cycle(Pasajeros) == 8)
d0806 <- 1*(trunc(time(Pasajeros)) == 2006 & cycle(Pasajeros) == 8)
d0310 <- 1*(trunc(time(Pasajeros)) == 2010 & cycle(Pasajeros) == 3)

PasajerosAri <- Arima(Pasajeros,
                      lambda = 0,
                      order = c(0, 1, 1),  
                      seasonal = list(order = c(0, 1, 1), period = 12),
                      xreg = cbind(DiasLaborables, DiasNoLaborables, 
                                   LunesNavidad, DiasPreSanta, DiasPascua,
                                   d0402, d0805, d0806, d0310))
PasajerosAri

error <- residuals(PasajerosAri)
sderror <- sd(error)

autoplot(error, series="Error",
         colour = "black",
         xlab = "",
         ylab = "Error",
         main = "Figura 5.5. Error + Intervención. Modelo ARIMA") +
  geom_hline(yintercept = c(-3, -2, 0, 2, 3)*sderror, 
             colour = c("red", "blue", "black", "blue", "red"), 
             lty = 2) + 
  scale_x_continuous(breaks= seq(1996, 2019, 2))
```

Antes de finalizar el proceso de identificación vamos a confirmar la significatividad de todos los parámetros estimados haciendo uso del estadístico de Wald.

```{r}
datos <- NULL
for(i in 1:length(coef(PasajerosAri))) {
  datos <- rbind(datos,
                 data.frame(
                   "Coeficiente" = names(coef(PasajerosAri))[i],
                   "Valor de p" = wald.test(b = coef(PasajerosAri), 
                                            Sigma = vcov(PasajerosAri), 
                                            Terms = i)$result$chi2[3])
                 )
}
kable(datos, digits = 4, row.names = FALSE, caption = "Contrastes de significatividad")
```

\

## Validación del modelo

En el proceso de validación analizaremos la calidad de ajuste y predicción del modelo estimado.

\

### Calidad del ajuste {-}

Analizando los criterios de bondad de ajuste (sobre el error de predicción intra-muestral a un periodo vista) se tiene un error medio (ME) de `r round(accuracy(PasajerosAri)[1],2)` que es prácticamente cero por lo que no parece que haya sesgo en las predicciones; en media nos equivocamos `r round(accuracy(PasajerosAri)[2],1)` millones de pasajeros (RMSE) y el error porcentual medio (MAPE) es `r round(accuracy(PasajerosAri)[5],1)`%, muy bajo. Para ambos indicadores de bondad de ajuste el error obtenido es la mitad que el visto con alisado.

```{r,echo=FALSE}
round(accuracy(PasajerosAri),2)
```

\

### Calidad de las predicciones {-}

Se completará el proceso de validación estimado el error de predicción extra muestral según el horizonte temporal. Se considerarán 10 años para el periodo de estimación y un año para el de predicción.

```{r}  
k <- 120                  
h <- 12                   
T <- length(Pasajeros)    
s<-T - k - h            

mapeArima <- matrix(NA, s + 1, h)

X <- cbind(DiasLaborables, DiasNoLaborables, 
           LunesNavidad, DiasPreSanta, DiasPascua,
           d0402, d0805, d0806, d0310)

for (i in 0:s) {
  train.set <- subset(Pasajeros, start = i + 1, end = i + k)
  test.set <-  subset(Pasajeros, start = i + k + 1, end = i + k + h) 
  
  X.train <- X[(i + 1):(i + k),]
  hay <- colSums(X.train)
  X.train <- X.train[, hay>0]
  
  X.test <- X[(i + k + 1):(i + k + h),]
  X.test <- X.test[, hay>0]
  
  if (length(X.train) > 0) {
    fit <- try(Arima(train.set, 
                     lambda = 0,
                     order = c(0, 1, 1),
                     seasonal = list(order = c(0, 1, 1), period = 12),
                     xreg=X.train), silent = TRUE)} else {
                       fit <- try(Arima(train.set,
                                        lambda = 0,
                                        order = c(0, 1, 1),
                                        seasonal = list(order = c(0, 1, 1), 
                                                        period = 12)), 
                                  silent = TRUE)
                     }
  
  if (!is.element("try-error", class(fit))) {
    if (length(X.train) > 0) fcast <- forecast(fit, h = h, xreg = X.test) else
      fcast <- forecast(fit, h = h)
    mapeArima[i + 1,] <- 100*abs(test.set - fcast$mean)/test.set
  }
}

errorArima <- colMeans(mapeArima, na.rm = TRUE)
round(errorArima, 2)
```

El error es creciente en el horizonte temporal de predicción. Para predicciones extra-muestrales a un periodo vista vale `r round(errorArima[1], 1)`%, algo superior al error de estimación, pero realmente bajo. Incluso para predicciones a doce meses vista, el error sigue siendo reducido, `r round(errorArima[12], 1)`%. Recordemos que para alisado era de 3.6% (Tabla 2).

\

## Interpretación del modelo estimado

El modelo estimado y validado corresponde al modelo de las aerolíneas con intervención: $ARIMA_{12}(0,1,1)(0,1,1) + AI$. La ecuación teórica completa del modelo es:
$$(1-L)(1-L^{12})\log(Pasajeros) = (1+\theta_1 L)(1 + \theta_{12} L^{12})\varepsilon_t+$$
$$\gamma_1 DiasLaborables +\gamma_2 DiasNoLaborables +\gamma_3 LunesNavidad+$$
$$\gamma_4 DiasPreSanta + \gamma_5 DiasPascua +$$
$$\gamma_6 d0402 +\gamma_7 d0805 +\gamma_8 d0806 +\gamma_9 d0310.$$

Si se desarrolla el modelo y se deja en función de la tasa de variación anual del número de pasajero, queda (la parte de intervención no cambia):

$$TVAPasajeros_t = TVAPasajeros_{t-1} + \theta_1 \varepsilon_{t-1} + \theta_{12} \varepsilon_{t-12}+ \theta_1 \theta_{12} \varepsilon_{t-13}+\varepsilon_t + AI.$$
Finalmente, el modelo estimado es:
$$\widehat{TVAPasajeros}_t = TVAPasajeros_{t-1} -0.53 \varepsilon_{t-1} -0.37 \varepsilon_{t-12}+ 0.20 \varepsilon_{t-13} +$$
$$0.034\cdot DiasLaborables +0.016\cdot DiasNoLaborables+ 0.026\cdot LunesNavidad$$
$$- 0.058\cdot DiasPreSanta - 0.025\cdot DiasPascua +$$
$$0.033\cdot d0402 +0.064\cdot d0805 +0.028\cdot d0806 +0.038\cdot d0310.$$
Interpretación:

* La tasa de variación anual del número de pasajeros en transporte urbano para un mes dado es la misma que la observada en el mes previo.
* Si hace uno, doce o trece meses se observó un número atípico de pasajeros, se debe tener en cuenta para corregir la predicción.
* Cada día adicional laborable en un mes supone un incremento en el número de pasajeros del 3.4% y cada día adicional no laborable del 1.6%.
* Si la Navidad cae en lunes y por tanto Nochebuena en domingo, ese mes de diciembre el número de pasajeros será un 2.6% superior a la de un mes de diciembre donde la Navidad no cae en lunes.
* Si los días laborables (lunes a jueves) de la Semana Santa caen en marzo, ese marzo el número de pasajeros cae un 5.8%, mientras que en abril se producirá un incremento del número de pasajeros en transporte urbano de la misma proporción.
* De la misma forma, si los días laborables (lunes a viernes) de la semana posterior a Domingo de Resurrección caen en marzo, ese marzo el número de pasajeros cae un 2.5%, mientras que en abril se producirá un incremento del número de pasajeros en transporte urbano de la misma proporción.
* Ademas, para cuatro meses se observó una tasa de variación anual atípicamente superior a la esperada.

\

## Predicción del número de pasajeros en transporte urbano

Una vez dado por válido el modelo, podemos pasar a realizar predicciones para los próximos años. Para las variables de intervención sujetas a fecha de calendario ya hemos ido creando sus valores previstos, para las demás los fijaremos a cero.

```{r}
pPasajerosAri <- forecast(PasajerosAri, 
                          h = 60,
                          xreg = cbind(pDiasLaborables, pDiasNoLaborables, 
                                       pLunesNavidad, pDiasPreSanta, pDiasPascua,
                                       rep(0, 60), rep(0, 60), 
                                       rep(0 ,60), rep(0, 60)), 
                          level = 95)
autoplot(pPasajerosAri, 
         xlab = "",
         ylab = "",
         main = "Figura 5.6. Pasajeros (1996-2019) y predicción (2020-2024). Modelo Arima.") +
  scale_x_continuous(breaks= seq(1996, 2024, 4))
```

Así, en 2020 se esperan `r round(sum(pPasajerosAri$mean[1:12]), 0)` millones de pasajeros y para 2021 un total de `r round(sum(pPasajerosAri$mean[13:24]), 0)` millones de pasajeros.

\
\
\

# Comparación entre modelos

Para finalizar este análisis, vamos a comparar la calidad de ajuste y de predicción de los tres modelos estimados en este ejemplo: el método ingenuo con estacionalidad, el método de Alisado exponencial y el modelo Arima.

Recordemos que el método ingenuo con estacionalidad tenía un error de ajuste del `r round(accuracy(PasajerosSnaive)[5], 1)`% o `r round(accuracy(PasajerosSnaive)[2], 1)` millones de pasajeros (RMSE). Mientras que para el mejor modelo de alisado obtenido (ETS(M,Ad,A)) se tiene un error absoluto porcentual del `r round(accuracy(PasajerosEts)[5], 1)`% equivalente a `r round(accuracy(PasajerosEts)[2], 1)` millones de pasajeros. Por último, el modelo ARIMA presenta un error de `r round(accuracy(PasajerosAri)[5], 1)`% o `r round(accuracy(PasajerosAri)[2], 1)` millones de pasajeros. 

Claramente, el modelo de alisado supone una mejora sustancial sobre el método ingenuo y el modelo ARIMA sobre el de alisado con una reducción, en este último caso, del 50% en los dos indicadores de calidad contemplados.

Respecto de la calidad de las predicciones extra-muestrales, la figura 6.1 muestra los valores para el modelo de Alisado y ARIMA.

```{r}
datos <- data.frame(
  factor = c(rep("Alisado", 12), 
             rep("Arima", 12)),
  x = c(1:12, 1:12),
  y = c(errorAlisadoPas, errorArima)
)

ggplot(datos, aes(x = x, y = y,  colour= factor)) + 
  geom_line() +
  ggtitle("Figura 6.1. Error de predicción (MAPE) según horizonte temporal y enfoque") +
  xlab("Horizonte temporal de predicción") +
  ylab("%") +
  scale_x_continuous(breaks= 1:12) +
  scale_y_continuous(breaks= seq(1.5, 4, .5)) +
  guides(colour = guide_legend(title = "Métodos")) + 
  theme(legend.position=c(0.02,0.98), legend.justification=c(0,1))
```

Con independencia del horizonte temporal, el error de previsión extra-muestral del modelo ARIMA es menor que el error del modelo de alisado, aunque la diferencia se reduce conforme aumenta el horizonte temporal de previsión. En concreto, para previsiones a un mes vista, ARIMA comete un error 0.8 puntos porcentuales menor que el alisado, mientras que para predicciones a seis meses vista la diferencia es solo de medio punto y para un horizonte de doce meses de 0.4 puntos.

El método ARIMA nos permite obtener la predicciones más precisas y además entender un poco mejor cuales son los determinantes del número de pasajeros en transporte urbano y su efecto sobre la serie. El método de Alisado exponencial permite obtener predicciones bastante buenas con una simple línea de código. La conveniencia de uno o otro método dependerá de la importancia que se dé a la calidad de las predicciones, la comprensión de los determinantes de la serie o la complejidad de la metodología, entre otros aspectos.

\
\

# Lista de funciones utilizadas


|Paquete        |Funciones          |Paquete        |Funciones |
|:--------------|:------------------|:--------------|:------------------|
| aod      | wald.test        | forecast  | ggsubseriesplot        |
| base     | abs              |           | monthdays        |
|          | as.Date          |           | ndiffs        |
|          | as.numeric       |           | nsdiffs        |
|          | as.POSIXlt       |           | remainder        |
|          | c                |           | snaive        |
|          | cbind            | ggplot2   | aes        |
|          | class            |           | geom_hline        |
|          | colMeans         |           | geom_line        |
|          | colnames         |           | geom_point        |
|          | colSums          |           | ggplot                |
|          | data.frame       |           | ggtitle        |
|          | diff             |           | guide_legend        |
|          | expression       |           | guides        |
|          | is.element       |           | scale_colour_manual        |
|          | length           |           | scale_x_continuous        |
|          | library          |           | scale_y_continuous        |
|          | list             |           | theme        |
|          | log              |           | theme_bw        |
|          | matrix           |           | theme_set        |
|          | mean             |           | xlab        |
|          | names            |           | ylab        |
|          | nrow             | gridExtra | grid.arrange         |
|          | rbind            | knitr     | kable         |
|          | rep              | seasonal  | seas       |
|          | round            | stats     | aggregate        |
|          | rownames         |           | coef        |
|          | seq              |           | cycle        |
|          | subset           |           | residuals        |
|          | summary          |           | sd        |
|          | table            |           | stl        |
|          | tapply           |           | time         |
|          | trunc            |           | ts        |
|          | try              |           | vcov        |
| forecast | accuracy         | timeDate  | dayOfWeek        |
|          | Arima            |           | Easter        |
|          | auto.arima       |           | format        |
|          | autoplot         |           | isBizday        |
|          | autolayer        |           | timeCalendar        |
|          | easter           |           | timeSequence        |
|          | ets              | utils     | read.csv2        |
|          | forecast         |           |     |
|          | ggAcf            |           |     |

\
\
\
\

